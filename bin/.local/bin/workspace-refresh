#!/bin/bash

atHome=$(lsusb | grep 'Das Keyboard' | wc -l)
machine=$(hostname)

# First, check if HDMI is connected and enable/disable it
if [[ $machine == "minideb" ]]; then
  primaryDisplay="DisplayPort-0"
  secondaryDisplay="HDMI-A-0"
elif [[ $machine == "thinkpad" ]]; then
  primaryDisplay="HDMI-1"
  secondaryDisplay="eDP-1"
fi

primaryConnected=$(xrandr --query | grep --color=no ' connected ' | grep "$primaryDisplay" | wc -l)
secondaryConnected=$(xrandr --query | grep --color=no ' connected ' | grep "$secondaryDisplay" | wc -l)

if [[ $secondaryConnected == 0 ]]; then
  xrandr --output "$secondaryDisplay" --off

else
  if [[ $atHome == 1 ]]; then
    option="--left-of"
  else
    option="--right-of"
  fi

  echo "Displays: primary: $primaryDisplay, secondary: $secondaryDisplay."
  xrandr --output "$secondaryDisplay" --auto $option "$primaryDisplay"
  i3-msg '[workspace="1"]' move workspace to output "$secondaryDisplay"
  i3-msg '[workspace="2"]' move workspace to output "$primaryDisplay"
  i3-msg '[workspace="3"]' move workspace to output "$secondaryDisplay"
  i3-msg '[workspace="4"]' move workspace to output "$primaryDisplay"
  i3-msg '[workspace="5"]' move workspace to output "$primaryDisplay"
fi

# Then, force keyboard layout and remap caps lock to escape
# TODO: detect ABNT2 vs US-Intl layout in a proper way
# if grep 'Logitech Wireless Keyboard' /proc/bus/input/devices > /dev/null; then
if [[ ! $atHome ]]; then
  # ABNT2 keyboard
  ibus engine xkb:br::por
else
  # Original keyboard (EN-US)
  ibus engine xkb:us:intl:eng
fi
source ~/.xprofile
